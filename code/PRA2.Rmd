---
title: 'PRA 2 - Análisis de datos FIFA 17'
author: "Autores : Pablo Román-Naranjo Varela y Adrián Vicente Gómez"
date: "Enero 2022"
output:
  pdf_document:
    highlight: zenburn
    number_sections: yes
    toc: yes
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: PEC-header.html
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r load_packages, include=FALSE}
library(caret)
library(ggplot2)
library(pROC)
```

\newpage

# Descripción del dataset

El dataset utilizado, fifa.csv, está disponible en Kaggle: https://www.kaggle.com/artimous/complete-fifa-2017-player-dataset-global. 
Este dataset contiene las **estadísticas de los jugadores en el videojuego Fifa 17**. Contiene 17588 filas con 53 variables diferentes para describir a cada jugador. 
Entre estas variables nos encontramos con las siguientes:

- Name (Nombre del jugador)
- Nationality (Nacionalidad del jugador)
- National_Position (Posición de juego en equipo nacional).
- National_Kit (Número de equipación en equipo nacional)
- Club (Nombre del club)
- Club_Position (Posición de juego en club)
- Club_Kit (Número de equipación en club)
- Club_Joining (Fecha en la que empezó en el club)
- Contract_Expire (Año finalización del contrato)
- Rating (Valoración global del jugador, entre 0 y 100)
- Height (Altura)
- Weight (Peso)
- Preffered_Foot (Pie preferido)
- Birth_Date (Fecha de nacimiento)
- Age (Edad)
- Preffered_Position (Posición preferida)
- Work_Rate (valoración cualitativa en términos de ataque-defensa)
- Weak_foot (valoración de 1 a 5 de control y potencia de la pierna no preferida)
- Skill_Moves (valoración de 1 a 5 de la habilidad en movimientos del jugador)
- El resto de variables son los distintos atributos que definen a un jugador en este juego.


En la actualidad, el fútbol forma parte de nuestra vida cotidiana y es el **deporte con un mayor impacto social**. Aunque no deja de ser un videojuego, FIFA maneja tantos detalles sobre los jugadores que los ojeadores y los empleados de los clubes lo usan como herramienta para buscar nuevos jugadores que de otra manera no podrían ver. Por ello, realizar un análisis estadístico de los datos de este juego podría permitir arrojar cordura por encima de los sentimientos a la hora de tomar diferentes decisiones. Como ejemplo de estos análisis, **en este documento se planteará**:

* Si en el año 2017, la diferencia entre valoración global entre los jugadores del Real Betis y el Real Madrid era mayor a 5 puntos.

* Obtener un modelo de regresión que nos permita estimar la valoración de un jugador a partir de un subjconjunto de sus atributos.

* Obtener un modelo de regresión que nos permita determinar qué jugadores tienen más probabilidades de ir con la selección española.

\newpage
# Intregración y selección de datos de interés a analizar

Se carga el archivo usando la función **read.csv()**, con el separador como coma. Además, se especifica que archivo está **codificado en UTF** para que pueda leer de manera correcta los caracteres especiales como tildes o diéresis.

```{r message=FALSE, warning=FALSE}

datos = read.csv("../data/fifa.csv", header=T, sep=",", fileEncoding = "UTF-8")

# inspeccionamos el dataset
head(datos)
```

Usando el comando **head()** se inspeccionan las primeras líneas del fichero, y se observa que se ha asignado correctamente el nombre de cada variable.

Para ver qué tipo de datos se asigna a cada variable se utiliza la función **str()**.

```{r message= FALSE, warning=FALSE}
str(datos)
```

Como se ve, se dispone de **53 variables** que describen a cada jugador, y el tipo en el que se han cargado.

\newpage

# Limpieza de los datos

## Análisis de valores ausentes

Para realizar un análisis de los datos, realizamos un resumen de los mismos con la función **summary()**.
```{r message= FALSE, warning=FALSE}
summary(datos)
```
Si se observa el resumen realizado, en él es posible estudiar **qué variables disponen de valores ausentes**, marcados como NA's. En este caso, de **las variables numéricas referentes a estadísticas** de jugadores, **ninguna muestra valores ausentes**.

Donde sí se pueden observar **valores ausentes es en las variables National_Kit, National_Position, Club_Kit y Contract_Expiry**. En el caso de las dos primeras variables, National_Kit y National_Position, es normal la existencia de valores nulos, ya que solo encontraremos un valor en estas variables si el jugador forma parte actualmente de la selección de su país. En las otras dos variables, Club_Kit y Contract_Expiry, **solo existe un valor nulo**. Se puede comprobar que **este valor corresponde a un único jugador**.

```{r message= FALSE, warning=FALSE}
datos[is.na(datos$Club_Kit),]
```

Concretamente el jugador es **Didier Drogba**, siendo además un agente libre. En el caso de esta observación, **dado que no dispone de Posición en el club se eliminará ya que en los próximos apartados se usará dicha variable**.

```{r message= FALSE, warning=FALSE}
fifaNet = datos[!is.na(datos$Club_Kit),]
```

Por lo tanto, se dispone de unos datos limpios respecto a la ausencia de valores que podrán ser usados sin problemas.

## Valores extremos
Para analizar los **valores extremos** observamos nuevamente el summary de los datos. En este caso, **todas las estadísticas del jugador** se encuentran **entre 0 y 100** que son los **rangos habituales** de estos parámetros en el juego. Conviene realizar la **transformación del peso y la altura a variables numéricas** para así comprobar también si existe algún valor extremos que sea necesario tratar.

```{r message= FALSE, warning=FALSE}
# Tranformamos ambas variables
fifaNet$Height = as.numeric(gsub("[[:alpha:]]","",fifaNet$Height))
fifaNet$Weight = as.numeric(gsub("[[:alpha:]]","",fifaNet$Weight))
```
En este caso **se ha eliminado cualquier caracter alfabético de las variables**, aunque se podría también haber eliminado las cadenas 'kg' y 'cm' directamente. Comprobamos los boxplot de ambas variables para estas dos variables en búsqueda de valores extremos:

```{r message= FALSE, warning=FALSE}
par(mai=rep(0.6, 4))
layout(matrix(c(1,1, 2,2), ncol = 2))
boxplot(fifaNet$Height, main = "Height")
boxplot(fifaNet$Weight, main = "Weight")

```
Analizando ambas variables, aunque aparecen puntos fuera de los boxplot, se ve que **se mueven en rangos comunes** para peso y altura, por lo que no se identifican valores extremos.

\newpage

# Análisis de los datos

## Selección de los grupos de datos que se quiere analizar/comparar

En esta práctica haremos tres aproximaciones para analizar el dataset elegido. Estos análisis se dividirán en tres apartados:

+ **Estadística inferencial**

En este apartado **analizaremos las plantillas del Real Madrid y el Real Betis**. Plantearemos como pregunta de investigación si el *Rating* general de cada una de las plantillas se diferencian en más de 5 puntos. Para realizar este análisis deberemos hacer **dos grupos de datos**: madrid_players y betis_players. 

+ **Modelo de regresión lineal múltiple**

En el segundo apartado planteamos ajustar un modelo de regresión lineal múltiple para estimar el rating general de los jugadores. En este apartado **usaremos la totalidad del dataset (fifaNet)**, usando como variables explicativas las variables *Age*, *Weight*, *Club_Position*, *Vision*, *Ball_Control*, *Marking*, *Interceptions*, *Freekick_Accuracy*, *Short_Pass*, *Speed* y *Finishing*.

+ **Regresión logística**

En tercer y último apartado ajustaremos un modelo predictivo basado en **regresión logística para predecir la probabilidad de que un jugador vaya a la selección de su país**. En este caso, para que la muestra sea más homogénea, hemos seleccionado solo aquellos jugadores nacidos en España. Por tanto, en este apartado usaremos un **subconjunto extraido de fifaNet incluyendo las estadísticas de los jugadores españoles (fifaNet_spain)**.

## Estadística inferencial

En este primer análisis se desea saber si, en el año 2017 **la diferencia entre valoración global (*Rating*) entre los jugadores del Real Betis y el Real Madrid era mayor a 5 puntos**. Para ello se llevará a cabo un **contraste de hipótesis**.

### Comprobación de normalidad

Para comprobar si la variable *Rating* se distribuye de manera normal, se puede realizar su **histograma** y evaluar si se corresponde con una **distribución normal**.
```{r message= FALSE, warning=FALSE}
# se usa la raiz cuadrada del numero de datos para establecer cuantas columnas usar
hist(fifaNet$Rating, breaks=sqrt(nrow(fifaNet)))
```

A la vista del histograma, **parece que esta variable sigue una distribución aproximadamente normal**, pero con la cola derecha algo menor que la izquierda. Para confirmar la normalidad, se puede realizar un **Q-Q plot** de los valores de *Rating*.
```{r message= FALSE, warning=FALSE}
qqnorm(fifaNet$Rating)
qqline(fifaNet$Rating)
```

Dado que los puntos se adaptan casi a la perfección a la recta en el QQ plot, y debido al tamaño elevado de la muestra, **asumimos normalidad de la variable *Rating* ** por el teorema del límite central.

### Contraste de hipótesis para la diferencia de medias

#### Hipótesis nula y la alternativa

Se desea comprobar si la **valoración de los jugadores del Real Betis es 5 puntos menor que la de los jugadores del Real Madrid**. Para ello, las hipótesis para este caso se formulan del siguiente modo: 

$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_m -\mu_b=5\\
H_{1}: & \mu_m-\mu_b>5\\
\end{array}
\right.
$$
Siendo $\mu_{m}$ la media de la valoración de los jugadores del Real Madrid y $\mu_{b}$ la media de la valoración de los jugadores del Real Betis.

#### Test a aplicar

El test a aplicar sería un **test unilateral sobre la diferencia de medias de dos muestras independientes (varianzas desconocidas)**. Es un **test unilateral por la derecha** porque la pregunta de investigación cuestiona si la media de los jugadores del Real Madrid es mayor a la de los jugadores del Real Betis.

#### Aplicación y comprobación del test

Primeramente se deben obtener los datos de los jugadores del Real Madrid y Real Betis.

```{r message= FALSE, warning=FALSE}
betis_players = fifaNet$Rating[fifaNet$Club=="Real Betis"]
madrid_players = fifaNet$Rating[fifaNet$Club=="Real Madrid"]
length(betis_players)
length(madrid_players)
```

Dado que acabamos de comprobar la normalidad de la variable *Rating*, podemos asumir que esta normalidad se trasladará a los dos subconjuntos.

Para concretar más aún el test que se va a realizar, será necesario realizar un **test de homoscedasticidad**, dado que se desconocen las varianzas poblacionales. Con este test se comprobará si las varianzas son iguales o diferentes.

```{r message= FALSE, warning=FALSE}
var.test(betis_players, madrid_players)
```

Dado que la hipótesis nula implica igualdad de varianzas, y el p-valor obtenido es inferior al nivel de significación $\alpha$ (0.05), se rechaza la hipótesis nula y **se asume que las varianzas son diferentes**.

Por tanto, el test a aplicar será una t de Student con $\upsilon$ grados de libertad, también llamado **test de Welch**.

```{r message= FALSE, warning=FALSE}
t.test(madrid_players,betis_players, var.equal = FALSE,alternative = "greater",
       mu = 5)
```

### Interpretación del test

Se observa que el p-value obtenido es mayor que el nivel de significación 0,05, por tanto, **no se puede rechazar la hipótesis nula**, es decir, **la diferencia entre las plantillas del Betis y el Real Madrid en la temporada 2016/2017 era inferior a 5 puntos**, con una confianza del 95%.

## Modelo de regresión lineal múltiple

Se desea estimar un **modelo de regresión lineal múltiple** que tenga como variables explicativas: Age, Weight, Club_Position, Vision, Ball_Control, Marking, Interceptions, Freekick_Accuracy, Short_Pass, Speed y Finishing; y como **variable dependiente el Rating de los jugadores**. Antes de realizar el modelo será necesario establecer el nivel base de referencia en la variables categórica *Club_Position*.

Para obtener un resultado más fiable, se utilizará una **validación cruzada con 20 iteraciones**.

```{r cat}
library(caret)
# Fijamos como valor referencia el valor mayoritarío para variable cat.
if (!is.factor(fifaNet$Club_Position)){
  max_club = max(fifaNet$Club_Position)
}

fifaNet$Club_Position = relevel(factor(fifaNet$Club_Position), ref=max_club)
# 20-fold cv
fitControl = trainControl(method = "cv", number = 20, savePredictions = T)
# Modelo lineal Multiple
multi_model_1 = train(Rating~Age+Weight+Club_Position+Vision+Ball_Control+Marking
                      +Interceptions+Freekick_Accuracy+Short_Pass+Speed+Finishing,
                      data=fifaNet, method = "lm", trControl = fitControl)
summary(multi_model_1)
```

Para una mejor diagnosis del modelo, se toma el modelo construído y **se realiza un estudio de sus residuos**. Los residuos se definen como **la diferencia entre los valores observados en la muestra y los valores estimados por el modelo**. Los valores que tomen estos residuos determinarán la adecuación del modelo.

```{r residuos}
# Valores ajustados vs Residuos
par(mai=rep(0.6, 4))
layout(matrix(c(1,1, 2,2, 0, 3,3, 0), ncol = 4, byrow = TRUE))
plot(fitted(multi_model_1), residuals(multi_model_1), main="Diagrama de dispersión")
abline(h=0)
# QQ plot
qqnorm(residuals(multi_model_1), ylab="Residuos", main="Gráfico cuantil-cuantil")
qqline(residuals(multi_model_1))
# Histograma para comprobar normalidad
hist(residuals(multi_model_1), xlab = "Residuos", main="Histograma")
```

### Interpretación del modelo

Se obtiene un modelo con un **R2 de 0.56**, lo que significa que el modelo apenas explica el 50% de la variabilidad de los datos, lo cual nos dice que **no se trata de un buen modelo** y que sería necesario introducir más variables. No obstante, en el **diagrama de dispersión**, donde representamos en el 'eje x' los valores de los residuos y en el 'eje y' los valores estimados, podemos comprobar como **la nube de puntos no tiene ninguna estructura ordenada y los valores rondan el valor cero**. Esto es **indicativo de un modelo correcto**. Por otro lado, **en un modelo correcto** donde los datos sigan una distribución normal, **los valores de los residuos deben seguir también una distribución normal**. Esto lo podemos comprobar con un **gráfico cuantil-cuantil y/o un histograma**. Como podemos comprobar en ambos gráficos, **los residuos están normalmente distribuidos**.


De las variables utilizadas todas **resultan signficativas (p<0.05)** a excepción de alguna de las demarcaciones del jugador en su club.
Respecto a las demás:

* La edad, el peso, la vision, el control del balón, las interecpciones, pases cortos y velocidad **influyen positivamente** en el rating.

* Algunas posiciones como ser portero influye positivamente en el rating. Esto tiene sentido, ya que no se ha introducido ninguno de los atributos propios de porteros y por tanto, a pesar de tener valores más bajos, obtienen mejores medias.

* El marcaje, la precisión de tiro libre y la finalización **influyen de manera negativa** en el rating.

## Regresión logística 

Utilizando diferentes variables explicativas, como *Age* o *Rating*, se ajusta un **modelo predictivo basado en regresión logística** para predecir la **probabilidad de que un jugador vaya a la selección** de su país. Para que la muestra sea más homogénea, este modelo se realizará solo con **jugadores españoles** (Nationality == Spain).

Primero de todo, generaremos y usaremos la **variable dicotómica 'internacional'**. Esta variable tomará el valor **1 si el jugador forma parte de la selección** de su país, y 0 en el caso contrario.

```{r internacional}
fifaNet$internacional[is.na(fifaNet$National_Kit)] = 0
fifaNet$internacional[!is.na(fifaNet$National_Kit)] = 1
```

Para conseguir un mejor modelo, generaremos **otra variable dicotómica, esta vez llamada 'portero'**, para diferenciar los jugadores de campo ('Jugador') y los porteros ('Portero').

```{r}
fifaNet$portero[fifaNet$Club_Position=="GK"] = "Portero"
fifaNet$portero[fifaNet$Club_Position!="GK"] = "Jugador"
fifaNet$portero = as.factor(fifaNet$portero)
```

Filtramos el dataset original (fifaNet) para generar un segundo dataset solo con **jugadores españoles (fifaNet_spain)**. Será con este set de datos con el que se ajuste el modelo predictivo.

```{r spain}
fifaNet_spain = fifaNet[fifaNet$Nationality == "Spain", ]
```

Se realiza una 20-fold cross-validation mediante la función **trainControl()** del paquete *caret*.

```{r message=FALSE, warning=FALSE}
# 20-fold cv
fitControl = trainControl(method = "cv", number = 20, savePredictions = T)
# Ajuste del modelo (regresión logistica)
model_fit = train(internacional~Age+Rating+portero+Work_Rate,data=fifaNet_spain, 
                  method = "glm", family="binomial", trControl = fitControl)

# Valores predichos y observados 
pred_prob = (model_fit$pred)$pred
pred_bin = factor(ifelse(pred_prob >= 0.5, 1, 0))
obs_bin = factor((model_fit$pred)$obs)

# Matriz de confusión
confusionMatrix(table(pred_bin,obs_bin), positive = "1")
```

### Interpretación del modelo

Consideramos que hemos conseguido **un buen modelo para predecir si un jugador español es convocado o no por la selección**.

Se observa una estimación de la **precisión del modelo en torno al 99%**, lo cual es una precisión muy buena. Por otra parte, si se analiza la **sensibilidad, se observa que es del 74%**. Aunque está lejos del valor que toma la precisión, la posibilidad de acertar si un jugador seleccionado por su selección es aceptable. Por último, la **especificidad es casi del 100%**, es decir, la posibilidad de detectar realmente los casos en los que no irá a la selección es casi perfecta. Esto se visualiza mediante una **curva ROC**.

```{r roc, message=FALSE, warning=FALSE}
curve = roc(response=factor(fifaNet_spain$internacional),
            predictor=as.numeric(predict(model_fit)))
plot.roc(curve, main="ROC curve")
```

\newpage
# Conclusiones

Las conclusiones obtenidas a partir del análisis de los datos de jugadores de fútbol en el FIFA17 son:

* El contraste de hipótesis no nos ha permitido afirmar que existe una diferencia de más de 5 puntos entre los jugadores del Real Madrid y el Real Betis.

* Se obtenido un modelo de regresión lineal para la valoración media de cada jugador que a pesar de ser correcto, no ha mostrado una gran precisión, probablemente debido a que se ha mezclado jugadores de campo con porteros, y eso complica la obtención de la media de cada jugador.

* Se obtenido un modelo de regresión logística para determinar si un jugador tiene posibilidades o no de ir a la selección española. El modelo obtenido presenta una precisión de casi el 99% con una sensibilidad del 74% y una especificidad casi del 100%.

# Contribuciones

\begin{table}[ht]
\centering
\begin{tabular}{lr}
  \hline
Contribuciones & Firma \\ 
  \hline
Investigación previa & PRNV; AVG \\ 
  Redacción de las respuestas & PRNV; AVG \\ 
    Desarrollo código & PRNV; AVG\\ 
   \hline
\end{tabular}
\end{table}

# Fichero final

Se exporta el dataframe limpio a un fichero csv.
```{r message= FALSE, warning=FALSE}
write.csv(fifaNet,"../data/fifaNet.csv", col.names = T,row.names=F)
write.csv(fifaNet_spain,"../data/fifaNetSpain.csv", col.names = T,row.names=F)
```


# Repositorio del proyecto

El código de este proyecto así como los datos necesarios para ejecutarlo se encuentran disponibles en:

https://github.com/avicenteg/fifa_players_data_analysis

# Videopresentación

La presentación de este proyecto puede encontrarse en el siguiente enlace:

https://drive.google.com/file/d/16o1SK7LCqpd11X60F_pVhreMz6Hc2Bza/view?usp=sharing

